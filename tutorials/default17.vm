#upstateInitialize
<html lang="en-US">
<!-- step 17: add html and head attributes
page-level overriding the master setup
see master-override17 for an example of a script block overriding
the master setup; this block is to be attached to the block chooser named
master-level-override
-->
<head>
#upstateProcessHead
</head>
<body $upstateBodyAttributes>
#upstateProcessBodyPart1
#upstateProcessBodyPart2
#upstateProcessBodyPart3
</body>
</html>

#macro( upstateGetAttributes )
    #chanwReviveGlobalVariable( "HtmlAttributes" $design_namespace )
    #set( $upstateHtmlAttributes = $chanwReviveGlobalVariable )
    #chanwReviveGlobalVariable( "HeadAttributes" $design_namespace )
    #set( $upstateHeadAttributes = $chanwReviveGlobalVariable )
    #chanwReviveGlobalVariable( "BodyAttributes" $design_namespace )
    #set( $upstateBodyAttributes = $chanwReviveGlobalVariable )
    ## quotes are turned into &quot; and &apos; need to switch them back
    #set( $upstateHtmlAttributes = $upstateHtmlAttributes.replaceAll( '&apos;', "'" ).replaceAll( '&quot;', "'" ) )
    #set( $upstateHeadAttributes = $upstateHeadAttributes.replaceAll( '&apos;', "'" ).replaceAll( '&quot;', "'" ) )
    #set( $upstateBodyAttributes = $upstateBodyAttributes.replaceAll( '&apos;', "'" ).replaceAll( '&quot;', "'" ) )
#end

#macro( upstateInitialize )
    ## import the library
    #set( $core_site_name = "_chan_core" )    
    #import( "site://${core_site_name}/formats/library/velocity/chanw_library_import" )
    
    #* ---  the master setup format --- *#
    #set( $master_site_name = "_chan_master" )
    #import( "site://${master_site_name}/formats/${MASTER_SETUP_FORMAT_NAME}" )
    
    #* --- the master override --- *#
    ## for a root-level page, there is no current folder
    #set( $page = $_XPathTool.selectSingleNode( $contentRoot, "//system-folder[@current]/system-page[@current]" ) )
    ## root-level pages
    #if( $_PropertyTool.isNull( $page ) )
        #set( $page = $_XPathTool.selectSingleNode( $contentRoot, "//system-page[@current]" ) )
    #end   
    #set( $pageSystemDataStructure  = $page.getChild( "system-data-structure" ) )
    #set( $masterLevelOverrideContent = $pageSystemDataStructure.getChild( "admin-group" ).getChild( "master-level-override" ).getChild( "content" ) )
       
    #if( $masterLevelOverrideContent )
<div id="hide-master-level-override">
    #chanwProcessBlockChooser( $masterLevelOverrideContent ) ## there is no show-master-level-override anywhere
</div>
    #end

    ## after page-level override, if global variables have not been imported, import now
    #import( "site://${core_site_name}/formats/library/velocity/${MASTER_SETUP_GLOBAL_VARIABLES}" )

    #* --- the design setup format --- *#
    #chanwImportScript( "formats/${design_namespace}" $master_site_name $DESIGN_SETUP_FORMAT_NAME )
    
    #* --- the site setup format --- *#
    #chanwImportScript( "/" $currentPageSiteName $SITE_SETUP_FORMAT_NAME )
    #set( $siteSetupFormatExists = $chanwImportScript )
    
    #* --- the folder setup format --- *#
    #set( $folderSetupFormatExists = false )
    #chanwLocateAssetInAncestorFolder(
        $currentPage.ParentFolder.Path $currentPageSiteName "format" $FOLDER_SETUP_FORMAT_NAME )

    #if( $chanwLocateAssetInAncestorFolder != "" && $chanwLocateAssetInAncestorFolder.ParentFolder.Path != "/" )
        #set( $folderSetupFormatExists = true )
        #import( "site://${currentPageSiteName}/${chanwLocateAssetInAncestorFolder.ParentFolder.Path}/${FOLDER_SETUP_FORMAT_NAME}" )
    #end    
    
    #* --- the attribute strings for html, head, and body --- *#
    #upstateGetAttributes
#end

#macro( upstateProcessBodyPart1 ) ## before page contents
    #if( $design_namespace == "uco" )
        #chanwReviveGlobalVariable( "PrePage" $design_namespace )
        #import( $chanwReviveGlobalVariable )
    #elseif( $design_namespace == "rwd3" )
        #chanwReviveGlobalVariable( "GoogleNoscript" $design_namespace )
        #import( $chanwReviveGlobalVariable )
        
        #chanwReviveGlobalVariable( "Header" $design_namespace )
        #import( $chanwReviveGlobalVariable )
    #end
#end

#macro( upstateProcessBodyPart2 ) ## page contents
    <!--#protect<div class="page" id="page">#protect-->
    #if( $design_namespace == "uco" )
        #chanwReviveGlobalVariable( "Search" $design_namespace )
        #import( $chanwReviveGlobalVariable )
        #chanwReviveGlobalVariable( "Header" $design_namespace )
        #import( $chanwReviveGlobalVariable )
    #end
    
    #*===  page content   === *#

    #set( $data = $_XPathTool.selectNodes( $contentRoot, "calling-page/system-page/system-data-structure" )[0] )
    <h1>$_EscapeTool.xml( $_XPathTool.selectNodes( $data, "h1" )[0].Value )</h1>

    #set( $post_wysiwyg_chooser = $_XPathTool.selectNodes( $data, "post-wysiwyg-chooser" )[0] )
    #set( $post_wysiwyg_chooser_content = $post_wysiwyg_chooser.getChild( "content" ) )

    #if( $post_wysiwyg_chooser_content )
        #chanwProcessBlockChooser( $post_wysiwyg_chooser_content )
    #end

    #set( $post_wysiwyg_group_choosers = $_XPathTool.selectNodes( $data, "post-wysiwyg-group/post-wysiwyg-group-chooser" ) )

    #if( $post_wysiwyg_group_choosers.size() > 0 )
        #foreach( $chooser in $post_wysiwyg_group_choosers )
            #set( $post_wysiwyg_group_chooser_content = $chooser.getChild( "content" ) )
        
            #if( $post_wysiwyg_group_chooser_content )
                #chanwProcessBlockChooser( $post_wysiwyg_group_chooser_content )
            #end
        #end
    #end
    #*===  end page content   === *#
#end

#macro( upstateProcessBodyPart3 ) ## after page contents
    #chanwReviveGlobalVariable( "Footer" $design_namespace )
    #import( $chanwReviveGlobalVariable )

    <!--#protect</div>#protect-->
    
    #chanwReviveGlobalVariable( "Script" $design_namespace )
    #import( $chanwReviveGlobalVariable )
#end

#macro( upstateProcessHead )
    #chanwReviveGlobalVariable( "Google" $design_namespace )
    #import( $chanwReviveGlobalVariable )
    #chanwReviveGlobalVariable( "Meta" $design_namespace )
    #import( $chanwReviveGlobalVariable )
    #chanwReviveGlobalVariable( "Title" $design_namespace )
    #import( $chanwReviveGlobalVariable )
    #chanwReviveGlobalVariable( "Link" $design_namespace )
    #import( $chanwReviveGlobalVariable )
#end